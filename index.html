import { useState, useRef } from "react";
import html2canvas from "html2canvas";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";
import { Select, SelectTrigger, SelectContent, SelectItem } from "@/components/ui/select";

const initialRows = [
  { time: "08.00", task: "Absen", status: "", note: "" },
  { time: "08.00-09.30", task: "Briefing", status: "", note: "" },
  { time: "10.00", task: "Input pengeluaran patty cash di spreadsheet", status: "", note: "" },
  { time: "10.30", task: "Penginputan laba rugi produksi (Mei)", status: "", note: "" },
  { time: "11.00", task: "Input penjualan toko, grosir, kampas ke laporan harian", status: "", note: "" },
  { time: "11.10", task: "Pencocokan bukti transfer setoran toko dan kampas", status: "", note: "" },
  { time: "10.30", task: "Input pendapatan harian ke laporan omset & pengeluaran", status: "", note: "" },
  { time: "12.00", task: "ISHOMA", status: "", note: "" },
  { time: "13.00", task: "Kirim laporan harian omset ke grup Finance", status: "", note: "" },
  { time: "13.30", task: "Input pengeluaran di Booble", status: "", note: "" },
  { time: "14.00-16.00", task: "Perbaikan laporan laba rugi", status: "", note: "" },
  { time: "17.00", task: "Pengisian laporan hasil kerja format baru", status: "", note: "" },
];

export default function DailyReportForm() {
  const [rows, setRows] = useState(initialRows);
  const reportRef = useRef(null);

  const handleNoteChange = (index, value) => {
    const updatedRows = [...rows];
    updatedRows[index].note = value;
    setRows(updatedRows);
  };

  const handleTimeChange = (index, value) => {
    const updatedRows = [...rows];
    updatedRows[index].time = value;
    setRows(updatedRows);
  };

  const handleTaskChange = (index, value) => {
    const updatedRows = [...rows];
    updatedRows[index].task = value;
    setRows(updatedRows);
  };

  const handleStatusChange = (index, value) => {
    const updatedRows = [...rows];
    updatedRows[index].status = value;
    setRows(updatedRows);
  };

  const addRow = () => {
    setRows([...rows, { time: "", task: "", status: "", note: "" }]);
  };

  const deleteRow = (index) => {
    const updatedRows = rows.filter((_, i) => i !== index);
    setRows(updatedRows);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    const element = reportRef.current;
    if (element) {
      const canvas = await html2canvas(element);
      const image = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.download = "laporan-harian.png";
      link.href = image;
      link.click();
    }
  };

  return (
    <form onSubmit={handleSubmit} className="p-4 space-y-4 max-w-4xl mx-auto">
      <h2 className="text-xl font-bold">Laporan Hasil Kerja Harian</h2>
      <div ref={reportRef} className="bg-white p-4 rounded shadow">
        <table className="w-full border text-sm">
          <thead>
            <tr className="bg-gray-100">
              <th className="border px-2 py-1">Jam</th>
              <th className="border px-2 py-1">Kegiatan</th>
              <th className="border px-2 py-1">Status</th>
              <th className="border px-2 py-1">Keterangan / Kendala</th>
              <th className="border px-2 py-1">Aksi</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((row, index) => (
              <tr key={index}>
                <td className="border px-2 py-1">
                  <Input
                    value={row.time}
                    onChange={(e) => handleTimeChange(index, e.target.value)}
                    placeholder="Jam"
                  />
                </td>
                <td className="border px-2 py-1">
                  <Input
                    value={row.task}
                    onChange={(e) => handleTaskChange(index, e.target.value)}
                    placeholder="Kegiatan"
                  />
                </td>
                <td className="border px-2 py-1">
                  <Select value={row.status} onValueChange={(value) => handleStatusChange(index, value)}>
                    <SelectTrigger className={row.status === "Selesai" ? "bg-green-100 text-green-700" : row.status === "Belum Selesai" ? "bg-red-100 text-red-700" : ""}>
                      {row.status || "Pilih Status"}
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Selesai">Selesai</SelectItem>
                      <SelectItem value="Belum Selesai">Belum Selesai</SelectItem>
                    </SelectContent>
                  </Select>
                </td>
                <td className="border px-2 py-1">
                  <Input
                    value={row.note}
                    onChange={(e) => handleNoteChange(index, e.target.value)}
                    placeholder="Keterangan / Kendala"
                  />
                </td>
                <td className="border px-2 py-1 text-center">
                  <Button type="button" variant="destructive" size="sm" onClick={() => deleteRow(index)}>Hapus</Button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="flex gap-4">
        <Button type="button" onClick={addRow} variant="outline">Tambah Aktivitas</Button>
        <Button type="submit">Kirim Laporan (Unduh Gambar)</Button>
      </div>
    </form>
  );
}
